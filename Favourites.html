<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Call Favourites</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<style>
  :root {
    --cream: #FDF6EC;
    --warm-white: #FFFAF4;
    --sand: #F0E4CE;
    --gold: #D4943A;
    --gold-light: #F2C46D;
    --gold-dark: #A8721F;
    --green: #4A8C5C;
    --green-light: #6DB88A;
    --red: #C0392B;
    --text-dark: #2C1F0E;
    --text-mid: #5C4A2A;
    --text-light: #8C7A60;
    --shadow-card: 0 6px 32px rgba(44,31,14,0.13);
    --radius: 24px;
    --radius-sm: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--cream);
    color: var(--text-dark);
    min-height: 100vh;
    max-width: 430px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    background-image:
      radial-gradient(ellipse at 10% 0%, rgba(212,148,58,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 90% 100%, rgba(74,140,92,0.07) 0%, transparent 60%);
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    background: var(--warm-white);
    padding: 24px 24px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid var(--sand);
    box-shadow: 0 2px 12px rgba(44,31,14,0.06);
    position: sticky; top: 0; z-index: 100;
  }
  .header-title {
    font-family: 'Nunito', sans-serif;
    font-size: 28px; font-weight: 900; color: var(--text-dark); letter-spacing: -0.3px;
  }
  .header-title span { color: var(--gold); }
  .add-btn {
    background: var(--gold); color: white; border: none; border-radius: 50%;
    width: 52px; height: 52px; font-size: 30px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 3px 12px rgba(168,114,31,0.35);
    transition: background 0.15s, transform 0.1s; flex-shrink: 0;
  }
  .add-btn:active { background: var(--gold-dark); transform: scale(0.94); }

  /* â”€â”€ CONTACT LIST â”€â”€ */
  .contacts {
    padding: 12px 20px 120px;
    display: flex; flex-direction: column; gap: 14px; flex: 1;
  }
  .contact-card {
    background: var(--warm-white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    display: flex; align-items: center;
    overflow: hidden; cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s;
    min-height: 100px;
  }
  .contact-card:active {
    transform: scale(0.97);
    box-shadow: 0 2px 10px rgba(44,31,14,0.10);
    border-color: var(--green-light);
  }
  .contact-photo {
    width: 100px; height: 100px; flex-shrink: 0;
    background: var(--sand);
    display: flex; align-items: center; justify-content: center;
    font-size: 44px; font-weight: 800; color: var(--gold); user-select: none;
  }
  .contact-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .contact-info {
    flex: 1; padding: 18px 14px 18px 18px;
    display: flex; flex-direction: column; gap: 4px;
  }
  .contact-name { font-size: 26px; font-weight: 900; color: var(--text-dark); line-height: 1.15; }
  .contact-number { font-size: 16px; color: var(--text-light); font-weight: 600; }
  .call-pill {
    background: var(--green); color: white; border-radius: 50px;
    padding: 10px 18px; font-size: 16px; font-weight: 800;
    display: flex; align-items: center; gap: 6px;
    margin-right: 16px;
    box-shadow: 0 2px 8px rgba(74,140,92,0.3); flex-shrink: 0; white-space: nowrap;
  }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 16px; padding: 60px 30px; text-align: center;
  }
  .empty-icon { font-size: 72px; opacity: 0.35; }
  .empty-text { font-size: 24px; color: var(--text-mid); font-weight: 800; line-height: 1.3; }
  .empty-sub { font-size: 18px; color: var(--text-light); font-weight: 600; max-width: 260px; }
  .empty-arrow { font-size: 36px; color: var(--gold); animation: bounce 1.6s ease-in-out infinite; }
  @keyframes bounce {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* â”€â”€ MODAL OVERLAY â”€â”€ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(44,31,14,0.55);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: flex; align-items: flex-end;
    opacity: 0; pointer-events: none; transition: opacity 0.25s;
  }
  .overlay.visible { opacity: 1; pointer-events: all; }

  /* â”€â”€ MODAL SHEET â”€â”€ */
  .sheet {
    background: var(--warm-white);
    border-radius: 28px 28px 0 0;
    width: 100%; max-width: 430px; margin: 0 auto;
    padding: 0 0 40px;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
    box-shadow: 0 -8px 40px rgba(44,31,14,0.18);
    max-height: 92vh; overflow-y: auto;
  }
  .overlay.visible .sheet { transform: translateY(0); }
  .sheet-handle {
    width: 44px; height: 5px; background: var(--sand);
    border-radius: 99px; margin: 14px auto 0;
  }
  .sheet-header {
    padding: 20px 24px 16px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 2px solid var(--sand);
  }
  .sheet-title { font-size: 24px; font-weight: 900; color: var(--text-dark); }
  .sheet-close {
    background: var(--sand); border: none; border-radius: 50%;
    width: 40px; height: 40px; font-size: 20px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-mid); transition: background 0.15s;
  }
  .sheet-close:active { background: #e0d0ba; }

  /* â”€â”€ PHOTO PICKER â”€â”€ */
  .photo-picker-area {
    padding: 24px 24px 0;
    display: flex; flex-direction: column; align-items: center; gap: 14px;
  }
  .photo-preview {
    width: 130px; height: 130px; border-radius: var(--radius);
    background: var(--sand);
    display: flex; align-items: center; justify-content: center;
    font-size: 60px; overflow: hidden;
    border: 3px dashed var(--gold-light); position: relative;
  }
  .photo-preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .photo-placeholder-text {
    position: absolute; bottom: 8px;
    font-size: 12px; font-weight: 700; color: var(--text-light); text-align: center;
  }
  .photo-btns { display: flex; gap: 12px; width: 100%; }
  .photo-btn {
    flex: 1; background: var(--sand); border: none;
    border-radius: var(--radius-sm); padding: 14px 10px;
    font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700;
    color: var(--text-mid); cursor: pointer;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    transition: background 0.15s;
  }
  .photo-btn:active { background: #e0d0ba; }
  .photo-btn .btn-icon { font-size: 26px; }
  #fileInput, #cameraInput { display: none; }

  /* â”€â”€ FORM FIELDS â”€â”€ */
  .form-fields { padding: 20px 24px 0; display: flex; flex-direction: column; gap: 16px; }
  .field-label {
    font-size: 15px; font-weight: 700; color: var(--text-light);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; display: block;
  }
  .field-input {
    width: 100%; background: var(--sand); border: 2.5px solid transparent;
    border-radius: var(--radius-sm); padding: 16px 18px;
    font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 700;
    color: var(--text-dark); outline: none;
    transition: border-color 0.2s, background 0.2s; -webkit-appearance: none;
  }
  .field-input:focus { border-color: var(--gold); background: white; }
  .field-input::placeholder { color: var(--text-light); font-weight: 600; }

  /* â”€â”€ SAVE / DELETE BUTTONS â”€â”€ */
  .save-btn {
    margin: 24px 24px 0; width: calc(100% - 48px);
    background: var(--green); color: white; border: none;
    border-radius: var(--radius); padding: 20px;
    font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 800;
    cursor: pointer; box-shadow: 0 4px 16px rgba(74,140,92,0.3);
    display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: background 0.15s, transform 0.1s;
  }
  .save-btn:active { background: #3a7048; transform: scale(0.97); }
  .save-btn:disabled { background: var(--text-light); box-shadow: none; cursor: not-allowed; }
  .delete-btn {
    margin: 12px 24px 0; width: calc(100% - 48px);
    background: transparent; color: var(--red);
    border: 2.5px solid var(--red); border-radius: var(--radius); padding: 16px;
    font-family: 'Nunito', sans-serif; font-size: 20px; font-weight: 800;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: background 0.15s;
  }
  .delete-btn:active { background: #fce8e6; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”€â”€ CROP MODAL â”€â”€
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .crop-overlay {
    position: fixed; inset: 0;
    background: #1a1008;
    z-index: 400;
    display: flex; flex-direction: column;
    opacity: 0; pointer-events: none;
    transition: opacity 0.22s;
  }
  .crop-overlay.visible { opacity: 1; pointer-events: all; }

  .crop-top-bar {
    padding: 20px 20px 14px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .crop-title { font-size: 20px; font-weight: 800; color: white; }
  .crop-cancel-btn {
    background: rgba(255,255,255,0.12); color: white; border: none;
    border-radius: 50px; padding: 10px 20px;
    font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700;
    cursor: pointer;
  }

  .crop-hint {
    text-align: center; font-size: 15px; font-weight: 600;
    color: rgba(255,255,255,0.55); padding: 0 20px 14px; flex-shrink: 0;
  }

  /* The viewport where dragging/zooming happens */
  .crop-viewport {
    flex: 1;
    position: relative;
    overflow: hidden;
    touch-action: none;
    cursor: grab;
    user-select: none;
  }
  .crop-viewport:active { cursor: grabbing; }

  /* The actual image being dragged */
  #cropImg {
    position: absolute;
    transform-origin: 0 0;
    touch-action: none;
    user-select: none;
    pointer-events: none;
    /* position & scale set by JS */
  }

  /* Square crop guide overlay */
  .crop-guide {
    position: absolute; inset: 0;
    pointer-events: none;
  }
  /* Dark mask with a square hole cut out via clip-path */
  .crop-mask {
    position: absolute; inset: 0;
    pointer-events: none;
    /* drawn on canvas by JS â€” keeps it dynamic */
  }
  #cropGuideCanvas {
    position: absolute; inset: 0; width: 100%; height: 100%;
    pointer-events: none;
  }

  .crop-bottom-bar {
    padding: 18px 20px 36px;
    display: flex; gap: 12px; flex-shrink: 0;
  }
  .crop-use-btn {
    flex: 1; background: var(--green); color: white; border: none;
    border-radius: var(--radius); padding: 20px;
    font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 800;
    cursor: pointer; box-shadow: 0 4px 16px rgba(74,140,92,0.3);
    transition: background 0.15s;
  }
  .crop-use-btn:active { background: #3a7048; }

  /* â”€â”€ CALL FLASH â”€â”€ */
  .call-flash {
    position: fixed; inset: 0; background: var(--green); z-index: 500;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .call-flash.visible { opacity: 1; pointer-events: all; }
  .call-flash-photo {
    width: 160px; height: 160px; border-radius: 50%;
    background: rgba(255,255,255,0.2); overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    font-size: 70px; color: white;
    border: 5px solid rgba(255,255,255,0.5);
    animation: ringPulse 1.5s ease-in-out infinite;
  }
  .call-flash-photo img { width: 100%; height: 100%; object-fit: cover; }
  @keyframes ringPulse {
    0%,100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
    50% { box-shadow: 0 0 0 20px rgba(255,255,255,0); }
  }
  .call-flash-name { font-size: 38px; font-weight: 900; color: white; }
  .call-flash-label { font-size: 20px; color: rgba(255,255,255,0.8); font-weight: 600; }
  .end-btn {
    margin-top: 20px; background: var(--red); border: none; border-radius: 50%;
    width: 80px; height: 80px; font-size: 34px; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(192,57,43,0.4);
  }
</style>
</head>
<body>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="header-title">My <span>Favourites</span></div>
  <button class="add-btn" onclick="openAdd()" aria-label="Add favourite">ï¼‹</button>
</header>

<!-- â”€â”€ CONTACT LIST â”€â”€ -->
<div id="contactsWrap"></div>

<!-- â”€â”€ ADD / EDIT SHEET â”€â”€ -->
<div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
  <div class="sheet" id="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="sheetTitle">Add Favourite</span>
      <button class="sheet-close" onclick="closeSheet()">âœ•</button>
    </div>
    <div class="photo-picker-area">
      <div class="photo-preview" id="photoPreview">
        ğŸ“·<span class="photo-placeholder-text">No photo yet</span>
      </div>
      <div class="photo-btns">
        <button class="photo-btn" onclick="document.getElementById('cameraInput').click()">
          <span class="btn-icon">ğŸ“¸</span>Take Photo
        </button>
        <button class="photo-btn" onclick="document.getElementById('fileInput').click()">
          <span class="btn-icon">ğŸ–¼ï¸</span>Photo Library
        </button>
      </div>
      <input type="file" id="fileInput"   accept="image/*"                  onchange="handlePhoto(event)" />
      <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)" />
    </div>
    <div class="form-fields">
      <div>
        <label class="field-label" for="nameInput">Their Name</label>
        <input class="field-input" id="nameInput" type="text" placeholder="e.g. Sarah" autocomplete="off" oninput="checkForm()" />
      </div>
      <div>
        <label class="field-label" for="phoneInput">Phone Number</label>
        <input class="field-input" id="phoneInput" type="tel" placeholder="e.g. 555-123-4567" autocomplete="off" oninput="checkForm()" />
      </div>
    </div>
    <button class="save-btn" id="saveBtn" onclick="savePerson()" disabled>âœ“ &nbsp;Save</button>
    <button class="delete-btn" id="deleteBtn" onclick="deletePerson()" style="display:none;">ğŸ—‘ &nbsp;Remove</button>
  </div>
</div>

<!-- â”€â”€ CROP MODAL â”€â”€ -->
<div class="crop-overlay" id="cropOverlay">
  <div class="crop-top-bar">
    <span class="crop-title">Position the Head</span>
    <button class="crop-cancel-btn" onclick="cancelCrop()">Cancel</button>
  </div>
  <div class="crop-hint">Drag to move &nbsp;Â·&nbsp; Pinch to zoom</div>
  <div class="crop-viewport" id="cropViewport">
    <img id="cropImg" src="" alt="crop" draggable="false" />
    <canvas id="cropGuideCanvas"></canvas>
  </div>
  <div class="crop-bottom-bar">
    <button class="crop-use-btn" onclick="confirmCrop()">âœ“ &nbsp;Use Photo</button>
  </div>
</div>

<!-- â”€â”€ CALLING SCREEN â”€â”€ -->
<div class="call-flash" id="callFlash">
  <div class="call-flash-photo" id="callPhoto"></div>
  <div class="call-flash-name"  id="callName"></div>
  <div class="call-flash-label">Callingâ€¦</div>
  <button class="end-btn" onclick="endCall()">ğŸ“µ</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let contacts     = JSON.parse(localStorage.getItem('familyCaller') || '[]');
let editingIndex = -1;
let pendingPhoto = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const wrap = document.getElementById('contactsWrap');
  if (contacts.length === 0) {
    wrap.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
        <div class="empty-text">No favourites yet</div>
        <div class="empty-sub">Tap the + button above to add someone</div>
        <div class="empty-arrow">â˜ï¸</div>
      </div>`;
    return;
  }
  wrap.innerHTML = `<div class="contacts">${contacts.map((c, i) => `
    <div class="contact-card" onclick="callContact(${i})">
      <div class="contact-photo">
        ${c.photo ? `<img src="${c.photo}" alt="${c.name}" />` : initials(c.name)}
      </div>
      <div class="contact-info">
        <div class="contact-name">${esc(c.name)}</div>
        <div class="contact-number">${esc(c.phone)}</div>
      </div>
      <div class="call-pill">ğŸ“ Call</div>
    </div>
    <button onclick="event.stopPropagation(); openEdit(${i})" style="
      background:none;border:none;font-size:13px;font-weight:700;
      color:var(--text-light);text-align:right;padding:0 20px 6px;
      cursor:pointer;font-family:Nunito,sans-serif;display:block;width:100%;">
      âœï¸ Edit
    </button>
  `).join('')}</div>`;
}

function initials(name) {
  return (name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
}
function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function callContact(i) {
  const c = contacts[i];
  document.getElementById('callName').textContent = c.name;
  document.getElementById('callPhoto').innerHTML =
    c.photo ? `<img src="${c.photo}" />` : initials(c.name);
  document.getElementById('callFlash').classList.add('visible');
  setTimeout(() => { window.location.href = `tel:${c.phone.replace(/\D/g,'')}`; }, 400);
}
function endCall() {
  document.getElementById('callFlash').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD / EDIT SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdd() {
  editingIndex = -1;
  pendingPhoto = null;
  document.getElementById('sheetTitle').textContent = 'Add Favourite';
  document.getElementById('nameInput').value  = '';
  document.getElementById('phoneInput').value = '';
  resetPhotoPreview();
  document.getElementById('deleteBtn').style.display = 'none';
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('overlay').classList.add('visible');
}
function openEdit(i) {
  const c = contacts[i];
  editingIndex = i;
  pendingPhoto = c.photo || null;
  document.getElementById('sheetTitle').textContent = 'Edit ' + c.name;
  document.getElementById('nameInput').value  = c.name;
  document.getElementById('phoneInput').value = c.phone;
  const pp = document.getElementById('photoPreview');
  if (c.photo) { pp.innerHTML = `<img src="${c.photo}" alt="photo" />`; }
  else          { resetPhotoPreview(); }
  document.getElementById('deleteBtn').style.display = '';
  document.getElementById('saveBtn').disabled = false;
  document.getElementById('overlay').classList.add('visible');
}
function closeSheet() {
  document.getElementById('overlay').classList.remove('visible');
}
function handleOverlayClick(e) {
  if (e.target === document.getElementById('overlay')) closeSheet();
}
function resetPhotoPreview() {
  document.getElementById('photoPreview').innerHTML =
    `ğŸ“·<span class="photo-placeholder-text">No photo yet</span>`;
}
function checkForm() {
  const name  = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  document.getElementById('saveBtn').disabled = !(name && phone);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHOTO â†’ CROP FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = ev => openCrop(ev.target.result);
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CROP LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cropState = {
  imgW: 0, imgH: 0,           // natural image size
  x: 0, y: 0,                  // current image top-left in viewport coords
  scale: 1,                    // current zoom scale
  vpW: 0, vpH: 0,              // viewport dimensions
  cropSize: 0,                 // side length of square crop box
  cropX: 0, cropY: 0,          // crop box top-left in viewport
};

function openCrop(src) {
  const img = document.getElementById('cropImg');
  img.onload = () => {
    initCropState(img.naturalWidth, img.naturalHeight);
    drawGuide();
    document.getElementById('cropOverlay').classList.add('visible');
  };
  img.src = src;
}

function initCropState(imgW, imgH) {
  const vp     = document.getElementById('cropViewport');
  const vpW    = vp.clientWidth;
  const vpH    = vp.clientHeight;
  const margin = 40;
  const cropSize = Math.min(vpW, vpH) - margin * 2;

  // Scale image so its shorter side fills the crop box
  const scaleToFit = cropSize / Math.min(imgW, imgH);
  const scale      = Math.max(scaleToFit, cropSize / Math.max(imgW, imgH));

  const scaledW = imgW * scale;
  const scaledH = imgH * scale;

  // Crop box centred in viewport
  const cropX = (vpW - cropSize) / 2;
  const cropY = (vpH - cropSize) / 2;

  // Image centred under crop box
  const x = cropX + (cropSize - scaledW) / 2;
  const y = cropY + (cropSize - scaledH) / 2;

  cropState = { imgW, imgH, x, y, scale, vpW, vpH, cropSize, cropX, cropY };
  applyTransform();
}

function applyTransform() {
  const img = document.getElementById('cropImg');
  img.style.width  = cropState.imgW + 'px';
  img.style.height = cropState.imgH + 'px';
  img.style.transform =
    `translate(${cropState.x}px, ${cropState.y}px) scale(${cropState.scale})`;
}

function drawGuide() {
  const canvas = document.getElementById('cropGuideCanvas');
  const vp     = document.getElementById('cropViewport');
  canvas.width  = vp.clientWidth;
  canvas.height = vp.clientHeight;
  const ctx = canvas.getContext('2d');
  const { cropX, cropY, cropSize } = cropState;

  // Dark mask
  ctx.fillStyle = 'rgba(0,0,0,0.55)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Cut out the square
  ctx.clearRect(cropX, cropY, cropSize, cropSize);

  // Border
  ctx.strokeStyle = 'rgba(255,255,255,0.85)';
  ctx.lineWidth   = 3;
  ctx.strokeRect(cropX, cropY, cropSize, cropSize);

  // Rule-of-thirds grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth   = 1;
  for (let i = 1; i < 3; i++) {
    const x = cropX + (cropSize / 3) * i;
    const y = cropY + (cropSize / 3) * i;
    ctx.beginPath(); ctx.moveTo(x, cropY); ctx.lineTo(x, cropY + cropSize); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cropX, y); ctx.lineTo(cropX + cropSize, y); ctx.stroke();
  }

  // Corner handles
  const h = 22;
  ctx.strokeStyle = 'white';
  ctx.lineWidth   = 4;
  ctx.lineCap     = 'round';
  const corners = [
    [cropX, cropY, 1, 1], [cropX+cropSize, cropY, -1, 1],
    [cropX, cropY+cropSize, 1, -1], [cropX+cropSize, cropY+cropSize, -1, -1]
  ];
  corners.forEach(([cx, cy, dx, dy]) => {
    ctx.beginPath(); ctx.moveTo(cx, cy + dy*h); ctx.lineTo(cx, cy); ctx.lineTo(cx + dx*h, cy); ctx.stroke();
  });
}

// â”€â”€ DRAG â”€â”€
let drag = null;
const vp = document.getElementById('cropViewport');

vp.addEventListener('pointerdown', e => {
  if (e.touches && e.touches.length > 1) return;
  drag = { startX: e.clientX, startY: e.clientY, imgX: cropState.x, imgY: cropState.y };
  vp.setPointerCapture(e.pointerId);
});
vp.addEventListener('pointermove', e => {
  if (!drag || (e.touches && e.touches.length > 1)) return;
  cropState.x = drag.imgX + (e.clientX - drag.startX);
  cropState.y = drag.imgY + (e.clientY - drag.startY);
  clampPosition();
  applyTransform();
});
vp.addEventListener('pointerup',     () => { drag = null; });
vp.addEventListener('pointercancel', () => { drag = null; });

// â”€â”€ PINCH-TO-ZOOM â”€â”€
let pinch = null;
vp.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    drag = null;
    pinch = {
      dist:   Math.hypot(e.touches[0].clientX - e.touches[1].clientX,
                         e.touches[0].clientY - e.touches[1].clientY),
      scale:  cropState.scale,
      midX:   (e.touches[0].clientX + e.touches[1].clientX) / 2,
      midY:   (e.touches[0].clientY + e.touches[1].clientY) / 2,
      imgX:   cropState.x,
      imgY:   cropState.y,
    };
    e.preventDefault();
  }
}, { passive: false });

vp.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && pinch) {
    e.preventDefault();
    const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX,
                               e.touches[0].clientY - e.touches[1].clientY);
    const ratio   = newDist / pinch.dist;
    const minScale = cropState.cropSize / Math.max(cropState.imgW, cropState.imgH);
    cropState.scale = Math.max(minScale, Math.min(pinch.scale * ratio, 6));

    // Zoom around pinch midpoint
    const mx = pinch.midX;
    const my = pinch.midY;
    cropState.x = mx - (mx - pinch.imgX) * (cropState.scale / pinch.scale);
    cropState.y = my - (my - pinch.imgY) * (cropState.scale / pinch.scale);
    clampPosition();
    applyTransform();
  }
}, { passive: false });

vp.addEventListener('touchend', e => {
  if (e.touches.length < 2) pinch = null;
});

// â”€â”€ CLAMP: keep image covering the crop box â”€â”€
function clampPosition() {
  const { imgW, imgH, scale, cropX, cropY, cropSize } = cropState;
  const sw = imgW * scale;
  const sh = imgH * scale;
  // Right edge of image must reach right edge of crop box
  const maxX = cropX;
  const minX = cropX + cropSize - sw;
  // Bottom edge of image must reach bottom of crop box
  const maxY = cropY;
  const minY = cropY + cropSize - sh;

  cropState.x = Math.min(maxX, Math.max(minX, cropState.x));
  cropState.y = Math.min(maxY, Math.max(minY, cropState.y));
}

// â”€â”€ CONFIRM: render crop to canvas and export â”€â”€
function confirmCrop() {
  const { imgW, imgH, x, y, scale, cropX, cropY, cropSize } = cropState;

  // Map crop box back to image coords
  const srcX = (cropX - x) / scale;
  const srcY = (cropY - y) / scale;
  const srcW = cropSize / scale;
  const srcH = cropSize / scale;

  const outSize = 300; // export at 300Ã—300px â€” plenty for a contact thumbnail
  const canvas  = document.createElement('canvas');
  canvas.width  = outSize;
  canvas.height = outSize;
  const ctx     = canvas.getContext('2d');
  ctx.drawImage(document.getElementById('cropImg'), srcX, srcY, srcW, srcH, 0, 0, outSize, outSize);

  pendingPhoto = canvas.toDataURL('image/jpeg', 0.85);
  const pp = document.getElementById('photoPreview');
  pp.innerHTML = `<img src="${pendingPhoto}" alt="preview" />`;

  document.getElementById('cropOverlay').classList.remove('visible');
}

function cancelCrop() {
  document.getElementById('cropOverlay').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE / DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function savePerson() {
  const name  = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  if (!name || !phone) return;
  const person = { name, phone, photo: pendingPhoto };
  if (editingIndex >= 0) { contacts[editingIndex] = person; }
  else                   { contacts.push(person); }
  save();
  render();
  editingIndex = -1;
  pendingPhoto = null;
  document.getElementById('nameInput').value  = '';
  document.getElementById('phoneInput').value = '';
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('deleteBtn').style.display = 'none';
  resetPhotoPreview();
  closeSheet();
}
function deletePerson() {
  if (editingIndex < 0) return;
  if (!confirm(`Remove ${contacts[editingIndex].name}?`)) return;
  contacts.splice(editingIndex, 1);
  save();
  render();
  editingIndex = -1;
  pendingPhoto = null;
  closeSheet();
}
function save() {
  localStorage.setItem('familyCaller', JSON.stringify(contacts));
}

// â”€â”€ INIT â”€â”€
render();
</script>
</body>
</html>
